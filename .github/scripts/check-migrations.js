#!/usr/bin/env node

/**
 * Check for pending Prisma migrations and format output for PR comments
 *
 * This script:
 * 1. Detects if there are any pending migrations
 * 2. Formats them beautifully as markdown
 * 3. Exits with code 1 if migrations exist (requires approval)
 * 4. Exits with code 0 if no migrations (all clear)
 */

const fs = require("fs");
const path = require("path");

const MIGRATIONS_DIR = path.join(__dirname, "../../packages/db-client/prisma/migrations");

/**
 * Get list of migration files
 */
function getMigrations() {
  if (!fs.existsSync(MIGRATIONS_DIR)) {
    return [];
  }

  return fs
    .readdirSync(MIGRATIONS_DIR)
    .filter((name) => name !== "migration_lock.toml" && !name.startsWith("."))
    .sort();
}

/**
 * Parse migration directory name
 * Format: 20231201123045_add_user_table
 */
function parseMigrationName(dirname) {
  const match = dirname.match(/^(\d{14})_(.+)$/);
  if (!match) return { timestamp: dirname, name: dirname };

  const timestamp = match[1];
  const name = match[2].replace(/_/g, " ");

  // Format timestamp: 20231201123045 -> 2023-12-01 12:30:45
  const year = timestamp.slice(0, 4);
  const month = timestamp.slice(4, 6);
  const day = timestamp.slice(6, 8);
  const hour = timestamp.slice(8, 10);
  const minute = timestamp.slice(10, 12);
  const second = timestamp.slice(12, 14);

  const formatted = `${year}-${month}-${day} ${hour}:${minute}:${second}`;

  return { timestamp: formatted, name };
}

/**
 * Read migration SQL file
 */
function getMigrationSQL(dirname) {
  const sqlPath = path.join(MIGRATIONS_DIR, dirname, "migration.sql");

  if (!fs.existsSync(sqlPath)) {
    return null;
  }

  const sql = fs.readFileSync(sqlPath, "utf-8").trim();

  // Truncate long SQL
  if (sql.length > 500) {
    return sql.slice(0, 500) + "\n... (truncated)";
  }

  return sql;
}

/**
 * Format migrations as beautiful markdown
 */
function formatMigrations(migrations) {
  if (migrations.length === 0) {
    return null;
  }

  let output = `## ðŸ”„ Database Migrations Detected\n\n`;
  output += `> **âš ï¸ IMPORTANT:** This PR will run **${migrations.length}** database migration${migrations.length > 1 ? "s" : ""} when merged to production.\n\n`;
  output += `### Migration${migrations.length > 1 ? "s" : ""} to be applied:\n\n`;

  migrations.forEach((migration, index) => {
    const { timestamp, name } = parseMigrationName(migration);
    const sql = getMigrationSQL(migration);

    output += `#### ${index + 1}. ${name}\n\n`;
    output += `- **Timestamp:** \`${timestamp}\`\n`;
    output += `- **Directory:** \`${migration}\`\n\n`;

    if (sql) {
      output += `<details>\n`;
      output += `<summary>ðŸ“œ View SQL</summary>\n\n`;
      output += `\`\`\`sql\n${sql}\n\`\`\`\n\n`;
      output += `</details>\n\n`;
    }
  });

  output += `---\n\n`;
  output += `### âœ… Required Action\n\n`;
  output += `Before merging this PR:\n\n`;
  output += `1. **Review** the migrations above carefully\n`;
  output += `2. **Verify** they are safe to run in production\n`;
  output += `3. **Resolve** this comment thread to confirm approval\n\n`;
  output += `### ðŸš€ Deployment Process\n\n`;
  output += `When this PR is merged:\n\n`;
  output += `1. **Migrations run first** via \`prisma migrate deploy\` in Vercel build\n`;
  output += `2. **Build completes** with updated schema\n`;
  output += `3. **Deployment succeeds** with migrated database\n\n`;
  output += `> **Note:** If migrations fail, the build will fail and no deployment will occur.\n\n`;
  output += `---\n\n`;
  output += `<sub>ðŸ¤– This comment was automatically generated by the migration check workflow</sub>\n`;

  return output;
}

/**
 * Main execution
 */
function main() {
  const migrations = getMigrations();

  if (migrations.length === 0) {
    console.log("âœ… No pending migrations detected");
    process.exit(0);
  }

  const formatted = formatMigrations(migrations);

  // Output to file for GitHub Actions to use
  const outputFile = process.env.GITHUB_OUTPUT;
  if (outputFile) {
    // Use multiline string format for GitHub Actions
    const delimiter = "EOF_MIGRATION_COMMENT";
    fs.appendFileSync(outputFile, `migration_comment<<${delimiter}\n${formatted}\n${delimiter}\n`);
    fs.appendFileSync(outputFile, `has_migrations=true\n`);
  }

  // Also print to console
  console.log(formatted);

  // Exit with 1 to indicate migrations need approval
  process.exit(1);
}

main();
